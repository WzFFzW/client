<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Nohost</title>
    <style>
      html, body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
      }
      .disabled .action-btn {
        color: #ccc;
        cursor: not-allowed;
      }
      main {
        text-align: center;
        width: 200px;
        height: 80px;
        position: absolute;
        top: 50%;
        left: 50%;
        margin: -40px 0 0 -100px;
      }
      main button {
        width: 180px;
        height: 46px;
        font-size: 20px;
      }
      main button {
        background-color: #fe9455;
        color: #fff;
        border: none;
        border-radius: 2px;
        cursor: pointer;
        outline: none;
      }
      main button[disabled] {
        background-color: #ccc!important;
      }
      main button:hover {
        background-color: #f3803b;
      }
      main button:active {
        background-color: #ee7946;
      }
      main.enabled button {
        background-color: #188eee;
      }
      main.enabled button:hover {
        background-color: #147de2;
      }
      main.enabled button:active {
        background-color: #1774c9;
      }
      .action-bar {
        margin-top: 15px;
      }
      .action-bar a {
        margin: 0 8px;
      }
    </style>
    <script>
      window.onbeforeunload = () => '';
    </script>
    <script>
      const lan = require('lan-settings');
      const { shell } = require('electron');

      const $ = (id) => {
        return document.getElementById(id);
      };

      const isDisabled = () => {
        return $('main').className === 'disabled' || $('switchProxy').disabled;
      };

      let settingsWin;
      const openSettings = () => {
        if (isDisabled()) {
          return;
        }
        if (!settingsWin || settingsWin.closed) {
          settingsWin = window.open('http://local.wproxy.org/', null, 'width=1080');
        }
        settingsWin.focus();
      };
      let selectEnvWin;
      const openSelectEnv = () => {
        if (isDisabled()) {
          return;
        }
        if (!selectEnvWin || selectEnvWin.closed) {
          selectEnvWin = window.open('http://imweb.nohost.pro:8080/select.html');
        }
        selectEnvWin.focus();
      };
      const openHelp = () => {
        shell.openExternal('http://git.code.oa.com/imweb/nohost-client');
      };
      const disableAllWindows = () => {

      };
    </script>
  </head>
  <body>
    <main id="main" class="disabled">
      <button id="switchProxy" onclick="switchProxy()">启用</button>
      <div class="action-bar">
        <a class="action-btn" href="javascript:;" onclick="openSettings()">设置</a>
        <a class="action-btn" href="javascript:;" onclick="openSelectEnv()">选择环境</a>
        <a href="javascript:;" onclick="openHelp()">帮助</a>
      </div>
    </main>
    <script>
      const { enableProxy, disableProxy } = require('./lib');

      const switchProxy = () => {
        const btn = $('switchProxy');
        if (btn.disabled) {
          return;
        }
        const main = $('main');
        btn.disabled = true;
        if (main.className === 'enabled') {
          return disableProxy().then(() => {
            btn.disabled = false;
            main.className = 'disabled';
            btn.innerHTML = '启用';
          }).catch((e) => {
            btn.disabled = false;
            alert('操作失败，请稍后重试。');
            throw e;
          });
        }

        return enableProxy().then(() => {
            btn.disabled = false;
            main.className = 'enabled';
            btn.innerHTML = '关闭';
          }).catch((e) => {
            btn.disabled = false;
            alert('操作失败，请稍后重试。');
            throw e;
          });
      };

      const closeWindow = () => window.close();

      const init = async () => {
        try {
          await switchProxy();
        } catch (e) {
          if (confirm('启动失败，是否重试？')) {
            return await init();
          }
        }
        window.onbeforeunload = (e) => {
          if (!$('switchProxy').disabled && $('main').className === 'disabled') {
            return;
          }
          process.nextTick(() => {
            if (confirm('退出后将不能使用Nohost，确定退出？')) {
              switchProxy().then(closeWindow, closeWindow);
            }
          });
          return '';
        };
      };
      init();
    </script>
    <script>

      </script>
  </body>
</html>
